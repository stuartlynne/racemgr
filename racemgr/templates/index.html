<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Table</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
        }
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevent the container from scrolling */
        }
        #title-time-table {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: white;
            width: 100%;
        }
        .table-container {
            flex: 1;
            width: 100%;
            overflow-x: auto; /* Allow horizontal scrolling */
            overflow-y: auto; /* Scroll only the data table body */
        }
        table {
            width: 100%;
            margin-top: 0;
            table-layout: auto; /* Responsive table layout */
        }
        th, td {
            font-size: .6em;
            text-align: center;
            vertical-align: middle;
            padding: 1px !important; /* Ensure minimal padding */
            position: sticky;
            z-index: 1;
            box-sizing: border-box;
            border-bottom: 1px solid red;
        }
        thead th {
            position: sticky;
            top: 0;
            background-color: white !important; /* Fully opaque background */
            z-index: 3; /* Ensure header is above body rows */
            opacity: 1 !important; /* Ensure full opacity */
        }
        td.wrap-text {
            white-space: normal;
            word-wrap: break-word;
        }
        /* Hide columns beyond the 4th */
        .hide-columns td:nth-child(n+5),
        .hide-columns th:nth-child(n+5) {
            display: none;
        }
        /* Increased font size and bold for first 4 columns */
        .larger-columns td, .larger-columns th {
            font-size: .8em; /* Larger font size for first 4 columns */
        }
        .larger-columns td:first-child {
            font-weight: bold;
            font-size: 1em; /* 1em font size for the first column */
        }
        /* Increase font size for title table row */
        #title-row td {
            font-size: .8em; /* Larger font size for title row */
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Title and Race Time Table (pinned at the top) -->
        <table id="title-time-table" class="table table-bordered">
            <thead>
                <tr id="title-row">
                    <td id="race-title" colspan="3">Race Title Here</td>
                    <td id="race-time">00:00:00</td>
                </tr>
            </thead>
        </table>

        <!-- Main Data Table (scrollable within available space) -->
        <div class="table-container">
            <table id="data-table" class="table table-striped table-bordered">
                <thead>
                    <tr id="table-header">
                        <!-- Table header will be populated by WebSocket -->
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Table body will be populated by WebSocket -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Bootstrap JS and dependencies (Optional for enhanced Bootstrap functionality) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const wsUrl = `ws://${window.location.hostname}:{{ws_port}}/ws`; // WebSocket URL with dynamic port
        let socket;
        let reconnectDelay = 1000; // Start with a 1-second delay between reconnection attempts
        let showAllColumns = false; // Track toggle state, start by showing only 4 columns

        const tableTitle = document.getElementById('race-title');
        const raceTime = document.getElementById('race-time');
        const tableHeader = document.getElementById('table-header');
        const tableBody = document.getElementById('table-body');
        const titleRow = document.getElementById('title-row');
        const dataTable = document.getElementById('data-table');

        // Function to wrap text at commas or spaces
        function wrapText(text) {
            return text.replace(/([, ])/g, '$1\u200B');
        }

        // Function to toggle between showing all columns and first 4 columns with larger font
        function toggleColumns() {
            if (showAllColumns) {
                dataTable.classList.add('hide-columns'); // Hide all columns after the first 4
                dataTable.classList.add('larger-columns'); // Increase font size and make first column bold and 1em
            } else {
                dataTable.classList.remove('hide-columns'); // Show all columns
                dataTable.classList.remove('larger-columns'); // Revert font size and bold style
            }
            showAllColumns = !showAllColumns;
        }

        // Initialize with the first 4 columns shown and apply larger font
        function initializeColumns() {
            dataTable.classList.add('hide-columns'); // Hide all columns after the first 4
            dataTable.classList.add('larger-columns'); // Apply larger font size and bold first column
        }

        // Add click event listener to the title row to toggle columns
        titleRow.addEventListener('click', toggleColumns);

        // Function to connect WebSocket and handle reconnections
        function connectWebSocket() {
            socket = new WebSocket(wsUrl);

            // WebSocket message handler
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);

                // Check if it's a table definition
                if (data.type === 'definition') {
                    tableTitle.textContent = data.title;
                    tableBody.innerHTML = ''; // Clear the table body

                    tableHeader.innerHTML = ''; // Set new header
                    data.headers.forEach(header => {
                        const th = document.createElement('th');
                        th.textContent = header;
                        tableHeader.appendChild(th);
                    });
                }

                // Handle race time updates
                if (data.type === 'race_time') {
                    raceTime.textContent = data.time;
                }

                // Handle new table row data
                if (data.type === 'row') {
                    const tr = document.createElement('tr');
                    data.row.forEach((cell, index) => {
                        const td = document.createElement('td');
                        if (index >= data.row.length - 2) {
                            td.innerHTML = wrapText(cell); // Wrap text in last two cells
                            td.classList.add('wrap-text');
                        } else {
                            td.textContent = cell;
                        }
                        tr.appendChild(td);
                    });
                    tableBody.appendChild(tr);

                    // Auto-scroll to the bottom
                    const tableContainer = document.querySelector('.table-container');
                    tableContainer.scrollTop = tableContainer.scrollHeight;
                }
            };

            // WebSocket error handler
            socket.onerror = function(error) {
                console.error('WebSocket Error: ', error);
            };

            // WebSocket connection closed, try to reconnect
            socket.onclose = function(event) {
                console.log('WebSocket closed. Attempting to reconnect in ' + reconnectDelay / 1000 + ' seconds.');
                setTimeout(connectWebSocket, reconnectDelay); // Reconnect after delay
                reconnectDelay = Math.min(reconnectDelay * 2, 10000); // Exponentially increase delay, max 10 seconds
            };

            // Reset reconnect delay on successful connection
            socket.onopen = function() {
                console.log('WebSocket connected.');
                reconnectDelay = 1000; // Reset the delay on successful connection
            };
        }

        // Close WebSocket connection when the page unloads
        window.onbeforeunload = function() {
            socket.close();
        };

        // Initialize columns when the page loads
        window.onload = function() {
            initializeColumns();
            connectWebSocket();
        };
    </script>
</body>
</html>

